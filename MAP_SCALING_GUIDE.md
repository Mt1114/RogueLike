# 地图4倍缩放功能说明

## 概述

游戏现在支持将整个地图等比例放大4倍，这使得地图更加详细，游戏体验更加丰富。

## 主要修改

### 1. MapManager 类修改

- **构造函数**: 添加了 `scale_factor` 参数，默认为 4.0
- **瓦片尺寸**: 自动将原始瓦片尺寸乘以缩放因子
- **地图尺寸**: 根据缩放后的瓦片尺寸计算新的地图尺寸
- **图块缓存**: 预缓存时自动缩放所有图块
- **pyscroll 缩放**: 设置 `map_layer.zoom = scale_factor`

### 2. 游戏系统调整

- **游戏类**: 初始化 MapManager 时传入 `scale_factor=4.0`
- **补给生成**: 将生成边距从 100 像素调整为 400 像素
- **敌人生成**: 将生成边距从 100 像素调整为 400 像素

### 3. 碰撞检测

碰撞检测系统自动适应缩放，因为：
- 瓦片尺寸已经缩放
- 碰撞矩形使用缩放后的瓦片尺寸
- 移动组件自动获取正确的瓦片尺寸

## 缩放效果

### 地图尺寸变化
- **原始瓦片**: 32x32 像素
- **缩放后瓦片**: 128x128 像素 (4倍)
- **地图尺寸**: 相应增加4倍

### 游戏元素调整
- **玩家移动**: 自动适应新的瓦片尺寸
- **敌人生成**: 在更大的地图范围内生成
- **补给生成**: 在更大的地图范围内生成
- **光照系统**: 自动适应新的地图尺寸

## 性能考虑

### 内存使用
- 图块缓存会占用更多内存（4倍缩放）
- 建议在内存有限的设备上考虑降低缩放因子

### 渲染性能
- 更多像素需要渲染
- 如果性能有问题，可以考虑：
  - 降低缩放因子（如改为2.0）
  - 优化图块缓存策略
  - 减少同时渲染的图块数量

## 自定义缩放

### 修改缩放因子
在 `src/modules/game.py` 中修改：
```python
self.map_manager = MapManager(screen, scale_factor=2.0)  # 改为2倍缩放
```

### 调整生成边距
如果修改了缩放因子，需要相应调整生成边距：

**补给管理器** (`src/modules/items/health_supply_manager.py`):
```python
self.spawn_margin = 200  # 2倍缩放时使用200
```

**敌人管理器** (`src/modules/enemies/enemy_manager.py`):
```python
corner_offset = 200  # 2倍缩放时使用200
```

## 测试

运行测试脚本验证缩放功能：
```bash
python test_map_scaling.py
```

测试脚本功能：
- 显示地图尺寸和瓦片尺寸信息
- 允许使用 WASD 键移动相机
- 显示缩放因子和相机位置
- 验证地图渲染是否正确

## 注意事项

1. **地图文件**: 确保地图文件存在且格式正确
2. **内存使用**: 4倍缩放会显著增加内存使用
3. **性能**: 在低性能设备上可能需要降低缩放因子
4. **兼容性**: 所有现有功能都兼容缩放系统

## 故障排除

### 地图不显示
- 检查地图文件是否存在
- 确认 TMX 文件格式正确
- 查看控制台错误信息

### 性能问题
- 降低缩放因子
- 检查内存使用情况
- 优化图块缓存

### 碰撞检测问题
- 确认瓦片尺寸正确传递
- 检查移动组件的碰撞设置 